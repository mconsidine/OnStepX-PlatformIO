name: Build OnStepX main

# This workflow only runs when manually triggered
on:
  workflow_dispatch:

jobs:
  build-e4-branch:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout OnStepX repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    # get local version of ODrive library and install
    - name: Copy External 'ODriveArduino' Library
      # Check out the ODrive repo
      uses: actions/checkout@v4
      with:
        repository: odriverobotics/ODrive
        ref: master # Branch containing the library
        path: external_odrive_checkout # Temporary folder
        sparse-checkout: Arduino/ODriveArduino

    - name: Move ODrive Library to Local 'lib' Folder
      # Move the library files to the local PlatformIO lib directory
      run: |
        mkdir -p lib/
        mv external_odrive_checkout/Arduino/ODriveArduino lib/
        # Clean up the temporary directory
        rm -rf external_odrive_checkout
    
    - name: Copy complete nain source from upstream
      run: |
        echo "Adding upstream remote and fetching branches..."
        git remote add upstream https://github.com/hjd1964/OnStepX.git
        git fetch upstream main:upstream-main
        
        echo "Copying complete src/ directory from main branch..."
        echo "This ensures we get all dependencies including global NVS instance"
        
        # Copy the entire src directory from main
        # This includes:
        # - src/lib (core libraries including NVS)
        # - src/telescope (mount control)
        # - src/plugins (nain web interface, WiFi)
        # - Main .ino or .cpp files with global declarations
        rm -rf src
        
        git checkout upstream-main -- src
        
        # Also copy any root-level source files
        git checkout upstream-main -- '*.ino' '*.cpp' '*.h' 2>/dev/null || echo "No root-level source files found"
        
        echo "âœ“ Complete main source copied"
        
        echo ""
        echo "=== nain Source Structure ==="
        ls -la src/ 2>/dev/null || echo "src/ not found"
        echo ""
        ls -la src/plugins/ 2>/dev/null || echo "src/plugins/ not found"
        echo ""
        ls -la src/plugins/website/ 2>/dev/null || echo "src/plugins/website/ not found"
        echo ""
        ls -la src/telescope/ 2>/dev/null || echo "src/telescope not found"
        echo ""
        echo "Root source files:"
        ls -la *.ino *.cpp *.h 2>/dev/null || echo "No root source files"
    
    - name: Display final configuration
      run: |
        sed -i "s/^#define[[:space:]]\+SERIAL_B_BAUD_DEFAULT[[:space:]]\+.*$/#define SERIAL_B_BAUD_DEFAULT OFF/" Config.h
        grep "^#define SERIAL_B_BAUD_DEFAULT[[:space:]]" Config.h || echo "     serial b baud default : not defined"
        
        echo "=== Final Build Configuration ==="
        echo ""
        echo "Config.h defines: $(grep -c "^#define" Config.h)"
        echo ""
        echo "Key E4 defines:"
        grep "^#define PINMAP" Config.h || echo "     PINMAP: not defined"
        grep "^#define STATUS_LED" Config.h || echo "     STATUS_LED: not defined"
        grep "^#define AXIS1_DRIVER_MODEL" Config.h || echo "     AXIS1_DRIVER_MODEL: not defined"
        grep "^#define AXIS2_DRIVER_MODEL" Config.h || echo "     AXIS2_DRIVER_MODEL: not defined"
        grep "^#define AXIS1_STEPS_PER_DEGREE" Config.h || echo "     AXIS1_STEPS_PER_DEGREE: not defined"
        grep "^#define AXIS2_STEPS_PER_DEGREE" Config.h || echo "     AXIS2_STEPS_PER_DEGREE: not defined"
        grep "^#define AXIS1_DRIVER_MICROSTEPS" Config.h || echo "     AXIS1_DRIVER_MICROSTEPS: not defined"
        grep "^#define AXIS2_DRIVER_MICROSTEPS" Config.h || echo "     AXIS2_DRIVER_MICROSTEPS: not defined"
        grep "^#define AXIS1_DRIVER_REVERSE" Config.h || echo "     AXIS1_DRIVER_REVERSE : not defined"
        grep "^#define AXIS2_DRIVER_REVERSE" Config.h || echo "     AXIS2_DRIVER_REVERSE : not defined"
        grep "^#define MOUNT_TYPE" Config.h || echo "     MOUNT_TYPE : not defined"
        grep "^#define PEC_STEPS_PER_WORM_ROTATION" Config.h || echo "     PEC_STEPS_PER_WORM_ROTATION : not defined"
        echo ""
        echo "Source files:"
        echo "  Main file: $(ls *.ino 2>/dev/null || echo 'Not found')"
        echo "  src/lib/nv: $(ls src/lib/nv/*.h 2>/dev/null | wc -l) header files"
        echo "  src/plugins: $(find src/plugins -name '*.cpp' 2>/dev/null | wc -l) source files"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
    
    - name: Cache PlatformIO packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.platformio
          .pio
        key: ${{ runner.os }}-pio-main-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-main-
          ${{ runner.os }}-pio-
    
    - name: Build OnStepX firmware for main
      run: |
        echo "Current folder structure"
        ls -la
        cat Config.h
        cat Extended.config.h
        echo "End of current folder structure"
        ls ~/.platformio/packages/framework-arduinoespressif32/tools/partitions
        echo "Building OnStepX for main..."
        pio run -e esp32dev --disable-auto-clean
    
    - name: List build output files
      run: |
        echo "Build completed. Output files:"
        cp ~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin .pio/build/esp32dev/
        ls -la .pio/build/esp32dev/ || echo "Build directory not found"
    
    - name: Upload firmware binary
      uses: actions/upload-artifact@v4
      with:
        name: onstepx-main-firmware
        path: |
          .pio/build/esp32dev/firmware.bin
          .pio/build/esp32dev/firmware.elf
          .pio/build/esp32dev/bootloader.bin
          .pio/build/esp32dev/partitions.bin
          .pio/build/esp32dev/boot_app0.bin
          Config.h
        if-no-files-found: warn
        retention-days: 30
        
    #- name: Upload boot_app0.bin
    #  uses: actions/upload-artifact@v4
    #  with:
    #    name: boot_app0
    #    path: ~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin

    - name: Create firmware info file
      run: |
        BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        cat > firmware-info.txt << 'ENDOFFILE'
        OnStepX Firmware for E4
        ================================
        ENDOFFILE
        echo "Build Date: ${BUILD_DATE}" >> firmware-info.txt
        echo "Commit: ${{ github.sha }}" >> firmware-info.txt
        echo "Branch: ${{ github.ref_name }}" >> firmware-info.txt
        echo "" >> firmware-info.txt
        echo "Configuration:" >> firmware-info.txt
        echo "" >> firmware-info.txt
        echo "Source Components:" >> firmware-info.txt
        echo "- Complete main source (upstream main branch)" >> firmware-info.txt
        echo "  * ALL of src/ directory" >> firmware-info.txt
        echo "  * Main .ino file with global declarations" >> firmware-info.txt
        echo "  * src/lib (NVS, core libraries)" >> firmware-info.txt
        echo "  * src/telescope (mount control)" >> firmware-info.txt
        echo "  * src/plugins (WiFi, web interface)" >> firmware-info.txt
        echo "" >> firmware-info.txt
        echo "Target Board: main (ESP32)" >> firmware-info.txt
        echo "- Chip: ESP32 @ 240MHz" >> firmware-info.txt
        #echo "- Flash: 16MB" >> firmware-info.txt
        echo "- Drivers: 4x TMC2209 (UART)" >> firmware-info.txt
        echo "" >> firmware-info.txt
        #echo "Flash Instructions:" >> firmware-info.txt
        #echo "-------------------" >> firmware-info.txt
        #echo "esptool.py --chip esp32 --port /dev/ttyUSB0 \\" >> firmware-info.txt
        #echo "  --baud 921600 write_flash 0x10000 firmware.bin" >> firmware-info.txt
        echo "" >> firmware-info.txt
        echo "The Config.h file used for this build is included in the artifacts." >> firmware-info.txt
        cat firmware-info.txt
    
    - name: Upload firmware info
      uses: actions/upload-artifact@v4
      with:
        name: onstepx-main-firmware-info
        path: firmware-info.txt
        
    - name: Merge Final Binary
      run: |
        #per Chad Gray post on onstep dev subgroup
        #  https://onstep.groups.io/g/developer/message/4584
        #esptool --chip esp32 merge_bin \
        #        -o merged-firmware.bin \
        #        --flash_mode dio \
        #        --flash_freq 40m \
        #        --flash_size 4MB \
        #        0x1000 bootloader.bin \
        #        0x8000 partitions.bin \
        #        0xe000 boot.bin \
        #        0x10000 your_app.bin
        # 1. Define variables for clarity
        CHIP="esp32"
          
        # 2. Define the path to the main firmware built by PlatformIO
        #    (Assumes the environment is 'esp32dev')
        FIRMWARE_BIN=".pio/build/esp32dev/firmware.bin"

        # 3. Define paths for the other required files (bootloader, partitions, boot_app0)
        #    These files are typically generated by the ESP32 framework/PlatformIO build process.
        #    You must ensure these paths are correct relative to your project root or PlatformIO's cache.
        BOOTLOADER_BIN=".pio/build/esp32dev/bootloader.bin"
        PARTITIONS_BIN=".pio/build/esp32dev/partitions.bin"
        BOOT_APP0_BIN=".pio/build/esp32dev//boot_app0.bin"

        # 4. Execute the esptool.py merge_bin command
        #    PlatformIO installs esptool.py, making it available globally.
        pio pkg exec --package "platformio/tool-esptoolpy@~1.40501.0" -- esptool.py --chip ${CHIP} merge_bin \
          --flash_mode dio \
          --flash_freq 40m \
          --flash_size 4MB \
          0x1000 "${BOOTLOADER_BIN}" \
          0x8000 "${PARTITIONS_BIN}" \
          0xe000 "${BOOT_APP0_BIN}" \
          0x10000 "${FIRMWARE_BIN}" \
          -o FYSETC_main_firmware.bin

        echo "Merged binary created as FYSETC_main_firmware.bin"
        echo "On linux try: esptool.py --port /dev/ttyS0 --baud 460800 write_flash 0x0 FYSETC_main_firmware.bin"
        
    - name: ðŸ“¦ Upload Merged Binary Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FYSETC_main_firmware
        path: FYSETC_main_firmware.bin
          
    - name: Build summary
      run: |
        echo "### âœ… Build Completed for main" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Target:** main (ESP32)" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Source Strategy:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Complete main source (entire src/ directory)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Main file with global NVS instance" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… All nain dependencies included" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download firmware and Config.h from Artifacts section." >> $GITHUB_STEP_SUMMARY
