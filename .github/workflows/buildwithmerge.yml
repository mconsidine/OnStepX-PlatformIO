name: Build OnStepX for FYSETC E4 (Complete)

# This workflow only runs when manually triggered
on:
  workflow_dispatch:
    inputs:
      config_branch:
        description: 'Branch containing custom config files (optional)'
        required: false
        default: ''
      merge_configs:
        description: 'Merge E4 and main Config.h? (yes/no)'
        required: false
        default: 'yes'
      stepper_steps:
        description: 'Stepper motor steps'
        required: true
        default: 400
        options:
        - 200
        - 400
      micro_steps:
        description: 'Microsteps'
        required: true
        default: 32
        options:
        - 16
        - 32
        - 64
      gear_reduction_ratio:
        description: 'Reduction from motor to worm'
        required: true
        default: 3
        options:
        - 2
        - 3
        - 4
        - 5
      final_reduction:
        description: 'Teeth in worm gear'
        required: true
        default: 144
        options:
        - 144
        - 360
        
jobs:
  build-fysetc-e4:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout OnStepX repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    # get local version of ODrive library and install
    - name: Copy External 'ODriveArduino' Library
      # Check out the ODrive repo
      uses: actions/checkout@v4
      with:
        repository: odriverobotics/ODrive
        ref: master # Branch containing the library
        path: external_odrive_checkout # Temporary folder
        sparse-checkout: Arduino/ODriveArduino

    - name: Move ODrive Library to Local 'lib' Folder
      # Move the library files to the local PlatformIO lib directory
      run: |
        mkdir -p lib/
        mv external_odrive_checkout/Arduino/ODriveArduino lib/
        # Clean up the temporary directory
        rm -rf external_odrive_checkout
     
    - name: Copy complete E4 source from upstream
      run: |
        echo "Adding upstream remote and fetching branches..."
        git remote add upstream https://github.com/hjd1964/OnStepX.git
        git fetch upstream E4:upstream-e4
        git fetch upstream main:upstream-main
        
        echo "Copying complete src/ directory from E4 branch..."
        echo "This ensures we get all dependencies including global NVS instance"
        
        # Copy the entire src directory from E4
        # This includes:
        # - src/lib (core libraries including NVS)
        # - src/telescope (mount control)
        # - src/plugins (E4 web interface, WiFi)
        # - Main .ino or .cpp files with global declarations
        rm -rf src/plugins
        
        git checkout upstream-e4 -- src/plugins
        
        # Also copy any root-level source files
        git checkout upstream-e4 -- '*.ino' '*.cpp' '*.h' 2>/dev/null || echo "No root-level source files found"
        
        echo "âœ“ Complete E4 source copied"
        
        echo ""
        echo "=== E4 Source Structure ==="
        ls -la src/plugins 2>/dev/null || echo "src/plugins not found"
        echo ""
        echo "Root source files:"
        ls -la *.ino *.cpp *.h 2>/dev/null || echo "No root source files"
    
    - name: Merge Config.h files (E4 + main)
      if: github.event.inputs.merge_configs == 'yes'
      run: |
        echo "=== Merging Config.h from E4 and main ==="
        echo "Strategy: E4 takes precedence, main supplements"
        echo ""
        
        # Extract both Config.h files
        git show upstream-e4:Config.h > Config-e4.h
        git show upstream-main:Config.h > Config-main.h
        
        # Count defines
        E4_COUNT=$(grep -c "^#define" Config-e4.h || echo "0")
        MAIN_COUNT=$(grep -c "^#define" Config-main.h || echo "0")
        echo "E4 Config.h defines:   $E4_COUNT"
        echo "Main Config.h defines: $MAIN_COUNT"
        
        # Start with E4 (takes precedence)
        cp Config-e4.h Config.h
        
        # Extract define names
        grep "^#define" Config-e4.h | awk '{print $2}' | sort > e4-defines.txt
        grep "^#define" Config-main.h | awk '{print $2}' | sort > main-defines.txt
        
        # Find defines only in main
        comm -23 main-defines.txt e4-defines.txt > main-only.txt
        
        MAIN_ONLY=$(wc -l < main-only.txt)
        
        if [ "$MAIN_ONLY" -gt 0 ]; then
            echo ""
            echo "Found $MAIN_ONLY defines only in main (adding to Config.h):"
            cat main-only.txt | head -20
            [ "$MAIN_ONLY" -gt 20 ] && echo "... and $((MAIN_ONLY - 20)) more"
            
            # Add section header
            echo "" >> Config.h
            echo "" >> Config.h
            echo "// =============================================================================" >> Config.h
            echo "// ADDITIONS FROM MAIN BRANCH" >> Config.h
            echo "// The following settings were found in main but not in E4" >> Config.h
            echo "// Review and adjust as needed for your hardware" >> Config.h
            echo "// =============================================================================" >> Config.h
            echo "" >> Config.h
            
            # Add each main-only define with context
            while IFS= read -r define; do
                echo "// From main branch: $define" >> Config.h
                # Extract full definition including multi-line defines
                awk -v def="$define" '
                    $0 ~ "^#define " def {
                        print
                        while (sub(/\\$/, "")) {
                            getline
                            print
                        }
                        print ""
                    }
                ' Config-main.h >> Config.h
            done < main-only.txt
            
            echo ""
            echo "âœ“ Merged Config.h created"
            echo "  Base (E4):    $E4_COUNT defines"
            echo "  Added (main): $MAIN_ONLY defines"
            echo "  Total:        $(grep -c "^#define" Config.h) defines"
        else
            echo ""
            echo "âœ“ No unique defines in main (using E4 Config.h as-is)"
        fi
        
        # Cleanup
        rm -f Config-e4.h Config-main.h e4-defines.txt main-defines.txt main-only.txt
    
    - name: Apply custom configuration
      if: github.event.inputs.config_branch != ''
      run: |
        echo "Applying custom config from branch: ${{ github.event.inputs.config_branch }}"
        git fetch origin ${{ github.event.inputs.config_branch }}:config-temp
        
        # Copy custom Config.h if it exists (overrides merged version)
        if git show config-temp:Config.h >/dev/null 2>&1; then
            echo "Using custom Config.h from ${{ github.event.inputs.config_branch }}"
            git checkout config-temp -- Config.h
        else
            echo "No custom Config.h found, using merged version"
        fi
        
        git branch -D config-temp 2>/dev/null || true
    
    - name: Display final configuration
      run: |
        echo "=== Final Build Configuration ==="
        echo ""
        echo "Config.h defines: $(grep -c "^#define" Config.h)"
        echo "Key E4 defines:"
        grep "^#define PINMAP" Config.h || echo "     PINMAP: not defined"
        grep "^#define STATUS_LED" Config.h || echo "     STATUS_LED: not defined"
        grep "^#define AXIS1_DRIVER_MODEL" Config.h || echo "     AXIS1_DRIVER_MODEL: not defined"
        grep "^#define AXIS2_DRIVER_MODEL" Config.h || echo "     AXIS2_DRIVER_MODEL: not defined"
        grep "^#define AXIS1_STEPS_PER_DEGREE" Config.h || echo "     AXIS1_STEPS_PER_DEGREE: not defined"
        grep "^#define AXIS2_STEPS_PER_DEGREE" Config.h || echo "     AXIS2_STEPS_PER_DEGREE: not defined"
        grep "^#define AXIS1_DRIVER_MICROSTEPS" Config.h || echo "     AXIS1_DRIVER_MICROSTEPS: not defined"
        grep "^#define AXIS2_DRIVER_MICROSTEPS" Config.h || echo "     AXIS2_DRIVER_MICROSTEPS: not defined"
        grep "^#define AXIS1_DRIVER_REVERSE" Config.h || echo "     AXIS1_DRIVER_REVERSE : not defined"
        grep "^#define AXIS2_DRIVER_REVERSE" Config.h || echo "     AXIS2_DRIVER_REVERSE : not defined"
        grep "^#define MOUNT_TYPE" Config.h || echo "     MOUNT_TYPE : not defined"
        echo ${ github.event.inputs.stepper_steps * github.event.inputs.micro_steps * gear_reduction_ratio * final_reduction }
        grep "^#define PEC_STEPS_PER_WORM_ROTATION" Config.h || echo "     PEC_STEPS_PER_WORM_ROTATION : not defined"
        echo ""
        echo "Source files:"
        echo "  Main file: $(ls *.ino 2>/dev/null || echo 'Not found')"
        echo "  src/lib/nv: $(ls src/lib/nv/*.h 2>/dev/null | wc -l) header files"
        echo "  src/plugins: $(find src/plugins -name '*.cpp' 2>/dev/null | wc -l) source files"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
    
    - name: Cache PlatformIO packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.platformio
          .pio
        key: ${{ runner.os }}-pio-fysetc-e4-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-fysetc-e4-
          ${{ runner.os }}-pio-
    
    - name: Build OnStepX firmware for FYSETC E4
      run: |
        echo "Current folder structure"
        ls -la
        cat Config.h
        cat Extended.config.h
        echo "End of current folder structure"
        echo "Building OnStepX for FYSETC E4..."
        pio run -e esp32dev --disable-auto-clean
    
    - name: List build output files
      run: |
        echo "Build completed. Output files:"
        cp ~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin .pio/build/esp32dev/
        ls -la .pio/build/esp32dev/ || echo "Build directory not found"

    - name: Upload firmware binary
      uses: actions/upload-artifact@v4
      with:
        name: onstepx-fysetc-e4-firmware
        path: |
          .pio/build/esp32dev/firmware.bin
          .pio/build/esp32dev/firmware.elf
          .pio/build/esp32dev/bootloader.bin
          .pio/build/esp32dev/partitions.bin
          .pio/build/esp32dev/boot_app0.bin
          Config.h
        if-no-files-found: warn
        retention-days: 30
        
    - name: Create firmware info file
      run: |
        BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        cat > firmware-info.txt << 'ENDOFFILE'
        OnStepX Firmware for FYSETC E4
        ================================
        ENDOFFILE
        echo "Build Date: ${BUILD_DATE}" >> firmware-info.txt
        echo "Commit: ${{ github.sha }}" >> firmware-info.txt
        echo "Branch: ${{ github.ref_name }}" >> firmware-info.txt
        echo "" >> firmware-info.txt
        echo "Configuration:" >> firmware-info.txt
        echo "- Config merge: ${{ github.event.inputs.merge_configs }}" >> firmware-info.txt
        echo "- Custom config: ${{ github.event.inputs.config_branch }}" >> firmware-info.txt
        echo "" >> firmware-info.txt
        echo "Source Components:" >> firmware-info.txt
        echo "- Complete E4 source (upstream E4 branch)" >> firmware-info.txt
        echo "  * ALL of src/ directory" >> firmware-info.txt
        echo "  * Main .ino file with global declarations" >> firmware-info.txt
        echo "  * src/lib (NVS, core libraries)" >> firmware-info.txt
        echo "  * src/telescope (mount control)" >> firmware-info.txt
        echo "  * src/plugins (WiFi, web interface)" >> firmware-info.txt
        echo "- Config: Merged E4 + main (E4 precedence)" >> firmware-info.txt
        echo "" >> firmware-info.txt
        echo "Target Board: FYSETC E4 (ESP32)" >> firmware-info.txt
        echo "- Chip: ESP32 @ 240MHz" >> firmware-info.txt
        echo "- Drivers: 4x TMC2209 (UART)" >> firmware-info.txt
        echo "" >> firmware-info.txt
        echo "Flash Instructions:" >> firmware-info.txt
        echo "-------------------" >> firmware-info.txt
        echo "esptool.py --chip esp32 --port /dev/ttyUSB0 \\" >> firmware-info.txt
        echo "  --baud 921600 write_flash 0x00000 firmware.bin" >> firmware-info.txt
        echo "" >> firmware-info.txt
        echo "The Config.h file used for this build is included in the artifacts." >> firmware-info.txt
        cat firmware-info.txt
    
    - name: Upload firmware info
      uses: actions/upload-artifact@v4
      with:
        name: onstepx-fysetc-e4-firmware-info
        path: firmware-info.txt
    
    - name: Build summary
      run: |
        echo "### âœ… Build Completed for FYSETC E4" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Target:** FYSETC E4 (ESP32)" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
        echo "- Config merge: ${{ github.event.inputs.merge_configs }}" >> $GITHUB_STEP_SUMMARY
        echo "- Custom config: ${{ github.event.inputs.config_branch }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Source Strategy:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Complete E4 source (entire src/ directory)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Main file with global NVS instance" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… All E4 dependencies included" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Config.h merged (E4 + main additions)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download firmware and Config.h from Artifacts section." >> $GITHUB_STEP_SUMMARY

  
    - name: Merge Final Binary
      run: |
        #per Chad Gray post on onstep dev subgroup
        #  https://onstep.groups.io/g/developer/message/4584
        #esptool --chip esp32 merge_bin \
        #        -o merged-firmware.bin \
        #        --flash_mode dio \
        #        --flash_freq 40m \
        #        --flash_size 4MB \
        #        0x1000 bootloader.bin \
        #        0x8000 partitions.bin \
        #        0xe000 boot.bin \
        #        0x10000 your_app.bin
        # 1. Define variables for clarity
        CHIP="esp32"
          
        # 2. Define the path to the main firmware built by PlatformIO
        #    (Assumes the environment is 'esp32dev')
        FIRMWARE_BIN=".pio/build/esp32dev/firmware.bin"

        # 3. Define paths for the other required files (bootloader, partitions, boot_app0)
        #    These files are typically generated by the ESP32 framework/PlatformIO build process.
        #    You must ensure these paths are correct relative to your project root or PlatformIO's cache.
        BOOTLOADER_BIN=".pio/build/esp32dev/bootloader.bin"
        PARTITIONS_BIN=".pio/build/esp32dev/partitions.bin"
        BOOT_APP0_BIN=".pio/build/esp32dev//boot_app0.bin"

        # 4. Execute the esptool.py merge_bin command
        #    PlatformIO installs esptool.py, making it available globally.
        pio pkg exec --package "platformio/tool-esptoolpy@~1.40501.0" -- esptool.py --chip ${CHIP} merge_bin \
          --flash_mode dio \
          --flash_freq 40m \
          --flash_size 4MB \
          0x1000 "${BOOTLOADER_BIN}" \
          0x8000 "${PARTITIONS_BIN}" \
          0xe000 "${BOOT_APP0_BIN}" \
          0x10000 "${FIRMWARE_BIN}" \
          -o OnStepX_FYSETC_E4_firmware.bin

        echo "Merged binary created as OnStepX_FYSETC_E4_firmware.bin"
        echo "On linux try: esptool.py --port /dev/ttyS0 --baud 460800 write_flash 0x0 OnStepX_FYSETC_E4_firmware.bin"
        
    - name: ðŸ“¦ Upload Merged Binary Artifact
      uses: actions/upload-artifact@v4
      with:
        name: OnStepX_FYSETC_E4_firmware
        path: OnStepX_FYSETC_E4_firmware.bin
