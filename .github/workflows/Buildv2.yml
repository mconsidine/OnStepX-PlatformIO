name: Build OnStepX (vendored)

on:
  workflow_dispatch:
    inputs:
      build_target:
        description: 'Source to build'
        required: true
        default: main-head
        options: [
          'release-v10.18c',
          'release-v10.20a',
          'release-v10.24c',
          'main-head',
          'e4-head',
          'main-head+e4-overlay']

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------------------------
    # Checkout *your* build project
    # ------------------------------------------------------------
    - name: Checkout build harness
      uses: actions/checkout@v4

    # ------------------------------------------------------------
    # Fetch OnStepX sources into temp directory
    # ------------------------------------------------------------
    - name: Fetch OnStepX sources
      run: |
        case "${{ github.event.inputs.build_target }}" in
          release-v10.18c) REF=v10.18c ;;
          release-v10.20a) REF=v10.20a ;;
          release-v10.24c) REF=v10.24c ;;
          main-head)       REF=main ;;
          e4-head)         REF=E4 ;;
          main-head+e4-overlay) REF=main ;;
        esac

        echo "Using OnStepX ref: $REF"

        git clone --depth 1 --branch "$REF" \
          https://github.com/hjd1964/OnStepX.git onstepx-src

    # ------------------------------------------------------------
    # Optional E4 overlay fetch
    # ------------------------------------------------------------
    - name: Fetch E4 overlay
      if: github.event.inputs.build_target == 'main-head+e4-overlay'
      run: |
        git clone --depth 1 --branch E4 \
          https://github.com/hjd1964/OnStepX.git onstepx-e4

    # ------------------------------------------------------------
    # Stage sources into PlatformIO project
    # ------------------------------------------------------------
    - name: Stage OnStepX sources
      run: |
        echo "Staging OnStepX source tree"

        rm -rf src
        mkdir -p src

        cp -a onstepx-src/src/. src/

        # Config files (if present)
        cp onstepx-src/Config.h . 2>/dev/null || true
        cp onstepx-src/Extended.config.h . 2>/dev/null || true
        
    # ------
    # Apply Config settings to primary OnStepX
    # ------
    - name: Apply config settings to src
      run: |
        echo "Applying Config.h patches"
        
        sed -i "s/^#define[[:space:]]\+SERIAL_B_BAUD_DEFAULT[[:space:]]\+.*$/#define SERIAL_B_BAUD_DEFAULT OFF/" Config.h
        grep "^#define SERIAL_B_BAUD_DEFAULT[[:space:]]" Config.h || echo "     Serial B Baud Default : not defined"

    # ------------------------------------------------------------
    # Apply E4 overlay (config + plugins only)
    # ------------------------------------------------------------
    - name: Apply E4 overlay
      if: github.event.inputs.build_target == 'main-head+e4-overlay'
      run: |
        echo "Applying E4 overlay"

        cp onstepx-e4/Config.h . 2>/dev/null || true
        cp onstepx-e4/Extended.config.h . 2>/dev/null || true

        rm -rf src/plugins
        cp -a onstepx-e4/src/plugins src/
        
    # ------------------------------------------------------------
    # Vendor ODrive Arduino library (non-PlatformIO layout)
    # ------------------------------------------------------------
    #- name: Vendor ODriveArduino library
    #  run: |
    #    echo "Vendoring ODriveArduino library"

    #    # Clean any previous copy
    #    rm -rf lib/ODriveArduino
    #    mkdir -p lib

    #    # Clone ODrive repo
    #    git clone --depth 1 --branch 4a7c9b1 \
    #      https://github.com/odriverobotics/ODrive.git \
    #      external_odrive

    #    # Move only the Arduino library into lib/
    #    mv external_odrive/Arduino/ODriveArduino lib/

    #    # Cleanup temp clone
    #    rm -rf external_odrive

    # ------------------------------------------------------------
    # Build with PlatformIO
    # ------------------------------------------------------------
    - name: Install PlatformIO
      run: pip install platformio

    - name: Build firmware
      run: pio run -e esp32dev

    # ------------------------------------------------------------
    # Upload artifacts
    # ------------------------------------------------------------
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: onstepx-${{ github.event.inputs.build_target }}
        path: |
          .pio/build/**/firmware.*
        retention-days: 30

    # ------------------------------------------------------------
    # Cleanup vendored sources
    # ------------------------------------------------------------
    - name: Cleanup
      if: always()
      run: |
        rm -rf onstepx-src onstepx-e4 src Config.h Extended.config.h
