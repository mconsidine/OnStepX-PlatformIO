name: Build OnStepX v2

on:
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        required: true
        default: 'main-release'
        options:
          - main-release
          - e4-release
          - main-head
          - main-head+e4-config

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------------------------
    # Checkout MAIN repo (always required)
    # ------------------------------------------------------------
    - name: Checkout OnStepX
      uses: actions/checkout@v4
      with:
        repository: hjd1964/OnStepX
        fetch-depth: 0
        submodules: recursive

    # ------------------------------------------------------------
    # Select branch or release
    # ------------------------------------------------------------
    - name: Select build source
      run: |
        case "${{ github.event.inputs.build_mode }}" in
          main-release)
            git checkout $(git describe --tags --abbrev=0)
            ;;
          main-head)
            git checkout main
            ;;
          e4-release)
            git checkout E4
            ;;
          main-head+e4-config)
            git checkout main
            ;;
        esac

        echo "SOURCE_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

    # ------------------------------------------------------------
    # Checkout E4 for config/plugins only (conditional)
    # ------------------------------------------------------------
    - name: Checkout E4 (config/plugins only)
      if: github.event.inputs.build_mode == 'main-head+e4-config'
      uses: actions/checkout@v4
      with:
        repository: hjd1964/OnStepX
        ref: E4
        fetch-depth: 0
        path: e4-overlay

    # ------------------------------------------------------------
    # Apply E4 Config.h + plugins ONLY
    # ------------------------------------------------------------
    - name: Apply E4 Config and plugins
      if: github.event.inputs.build_mode == 'main-head+e4-config'
      run: |
        echo "Applying E4 Config.h and plugins to main HEAD"

        # Replace Config.h
        cp e4-overlay/Config.h Config.h

        # Replace plugins ONLY
        rm -rf src/plugins
        cp -a e4-overlay/src/plugins src/

    # ------------------------------------------------------------
    # Sanity checks
    # ------------------------------------------------------------
    - name: Verify PlatformIO source tree
      run: |
        test -f platformio.ini || exit 1
        test -d src || exit 1
        find src -name "*.cpp" | grep -q . || exit 1

    # ------------------------------------------------------------
    # PlatformIO build
    # ------------------------------------------------------------
    - name: Install PlatformIO
      run: pip install platformio

    - name: Build firmware
      run: pio run -e esp32dev

    # ------------------------------------------------------------
    # Firmware info
    # ------------------------------------------------------------
    - name: Create firmware-info.txt
      run: |
        {
          echo "OnStepX Firmware"
          echo "================"
          echo ""
          echo "Build Mode: ${{ github.event.inputs.build_mode }}"
          echo "Source SHA: $SOURCE_SHA"
          echo "Build Date: $(date -u)"
        } > firmware-info.txt

    # ------------------------------------------------------------
    # Upload artifacts
    # ------------------------------------------------------------
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: onstepx-${{ github.event.inputs.build_mode }}
        path: |
          .pio/build/esp32dev/firmware.bin
          .pio/build/esp32dev/firmware.elf
          firmware-info.txt
        retention-days: 30
