name: Build OnStepX (vendored)

on:
  workflow_dispatch:
    inputs:
      build_target:
        type: choice
        description: 'Source to build'
        required: true
        default: main-head
        options: 
        - release-v10.18c
        - release-v10.20a
        - release-v10.24c
        - main-head
        - e4-head
        - main-head+e4-overlay
        
      pin_map:
        type: choice
        description: 'Pin map'
        required: true
        default: FYSETC-E4
        options:
        - BTT_SKR_PRO
        - FYSETC-E4
        - MaxESP4
        - MaxPCB4
        - MaxSTM3
        - MiniPCB
        - MiniPCB2
        
      driver_model:
        type: choice
        description: 'Motor driver model'
        required: true
        default: TMC2209
        options: 
        - A4988
        - DRV8825
        - LV8729
        - S109
        - TMC2130
        - TMC5160
        - TMC2209
        - TMC2226
        
      stepper_steps:
        type: choice
        description: 'Stepper motor steps'
        required: true
        default: 400
        options:
        - 200
        - 400
        
      micro_steps:
        type: choice
        description: 'Microsteps'
        required: true
        default: 32
        options:
        - 16
        - 32
        - 64
        
      gear_reduction_ratio:
        type: choice
        description: 'Reduction from motor to worm'
        required: true
        default: 3
        options:
        - 2
        - 3
        - 4
        - 5
        
      final_reduction:
        type: choice
        description: 'Teeth in worm gear'
        required: true
        default: 144
        options:
        - 144
        - 360
        
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------------------------
    # Checkout *your* build project
    # ------------------------------------------------------------
    - name: Checkout build harness
      uses: actions/checkout@v4

    # ------------------------------------------------------------
    # Fetch OnStepX sources into temp directory
    # ------------------------------------------------------------
    - name: Fetch OnStepX sources
      run: |
        case "${{ github.event.inputs.build_target }}" in
          release-v10.18c) REF=v10.18c ;;
          release-v10.20a) REF=v10.20a ;;
          release-v10.24c) REF=v10.24c ;;
          main-head)       REF=main ;;
          e4-head)         REF=E4 ;;
          main-head+e4-overlay) REF=main ;;
        esac

        echo "Using OnStepX ref: $REF"

        git clone --depth 1 --branch "$REF" \
          https://github.com/hjd1964/OnStepX.git onstepx-src

    # ------------------------------------------------------------
    # Optional E4 overlay fetch
    # ------------------------------------------------------------
    - name: Fetch E4 overlay
      if: github.event.inputs.build_target == 'main-head+e4-overlay'
      run: |
        git clone --depth 1 --branch E4 \
          https://github.com/hjd1964/OnStepX.git onstepx-e4

    # ------------------------------------------------------------
    # Stage sources into PlatformIO project
    # ------------------------------------------------------------
    - name: Stage OnStepX sources
      run: |
        echo "Staging OnStepX source tree"

        rm -rf src
        mkdir -p src

        cp -a onstepx-src/src/. src/

        # Config files (if present)
        cp onstepx-src/Config.h . 2>/dev/null || true
        cp onstepx-src/Extended.config.h . 2>/dev/null || true
        
    # ------------------------------------------------------------
    # Apply E4 overlay (config + plugins only)
    # ------------------------------------------------------------
    - name: Apply E4 overlay
      if: github.event.inputs.build_target == 'main-head+e4-overlay'
      run: |
        echo "Applying E4 overlay"

        cp onstepx-e4/Config.h . 2>/dev/null || true
        cp onstepx-e4/Extended.config.h . 2>/dev/null || true

        rm -rf src/plugins
        cp -a onstepx-e4/src/plugins src/

    # ------
    # Apply Config settings
    # ------
    - name: Apply config settings to src
      run: |
        echo "Applying Config.h patches"
        
        grep "^#define PINMAP" Config.h || echo "     PINMAP: not defined"
        grep "^#define STATUS_LED" Config.h || echo "     STATUS_LED: not defined"
        grep "^#define AXIS1_DRIVER_MODEL" Config.h || echo "     AXIS1_DRIVER_MODEL: not defined"
        grep "^#define AXIS2_DRIVER_MODEL" Config.h || echo "     AXIS2_DRIVER_MODEL: not defined"
        grep "^#define AXIS1_STEPS_PER_DEGREE" Config.h || echo "     AXIS1_STEPS_PER_DEGREE: not defined"
        grep "^#define AXIS2_STEPS_PER_DEGREE" Config.h || echo "     AXIS2_STEPS_PER_DEGREE: not defined"
        grep "^#define AXIS1_DRIVER_MICROSTEPS" Config.h || echo "     AXIS1_DRIVER_MICROSTEPS: not defined"
        grep "^#define AXIS2_DRIVER_MICROSTEPS" Config.h || echo "     AXIS2_DRIVER_MICROSTEPS: not defined"
        grep "^#define AXIS1_DRIVER_REVERSE" Config.h || echo "     AXIS1_DRIVER_REVERSE : not defined"
        grep "^#define AXIS2_DRIVER_REVERSE" Config.h || echo "     AXIS2_DRIVER_REVERSE : not defined"
        grep "^#define MOUNT_TYPE" Config.h || echo "     MOUNT_TYPE : not defined"
        grep "^#define PEC_STEPS_PER_WORM_ROTATION" Config.h || echo "     PEC_STEPS_PER_WORM_ROTATION : not defined"
  
        sed -i "s/^#define[[:space:]]\+HOST_NAME[[:space:]]\+.*$/#define HOST_NAME OnStepX/" Config.h
        grep "^#define HOST_NAME[[:space:]]" Config.h || echo "     HOST_NAME : not defined"
   
        sed -i "s/^#define[[:space:]]\+SERIAL_B_BAUD_DEFAULT[[:space:]]\+.*$/#define SERIAL_B_BAUD_DEFAULT OFF/" Config.h
        grep "^#define SERIAL_B_BAUD_DEFAULT[[:space:]]" Config.h || echo "     Serial B Baud Default : not defined"

        temp_var=$(( ${{ github.event.inputs.driver_model }} ))
        sed -i "s/^#define[[:space:]]\+AXIS1_DRIVER_MODEL[[:space:]]\+.*$/#define AXIS1_DRIVER_MODEL $temp_var/" Config.h
        grep "^#define AXIS1_DRIVER_MODEL[[:space:]]" Config.h || echo "     AXIS1_DRIVER_MODEL : not defined"
        sed -i "s/^#define[[:space:]]\+AXIS2_DRIVER_MODEL[[:space:]]\+.*$/#define AXIS2_DRIVER_MODEL $temp_var/" Config.h
        grep "^#define AXIS2_DRIVER_MODEL[[:space:]]" Config.h || echo "     AXIS2_DRIVER_MODEL : not defined"
        
        temp_var=$(( 
            ${{ github.event.inputs.stepper_steps }} *
            ${{ github.event.inputs.micro_steps }} *
            ${{ github.event.inputs.gear_reduction_ratio }} *
            ${{ github.event.inputs.final_reduction }} / 360
        ))
        sed -i "s/^#define[[:space:]]\+AXIS1_STEPS_PER_DEGREE[[:space:]]\+.*$/#define AXIS1_STEPS_PER_DEGREE $temp_var/" Config.h
        grep "^#define AXIS1_STEPS_PER_DEGREE[[:space:]]" Config.h || echo "     AXIS1_STEPS_PER_DEGREE : not defined"
        sed -i "s/^#define[[:space:]]\+AXIS2_STEPS_PER_DEGREE[[:space:]]\+.*$/#define AXIS2_STEPS_PER_DEGREE $temp_var/" Config.h
        grep "^#define AXIS2_STEPS_PER_DEGREE[[:space:]]" Config.h || echo "     AXIS2_STEPS_PER_DEGREE : not defined"
        
        sed -i "s/^#define[[:space:]]\+AXIS1_DRIVER_MICROSTEPS[[:space:]]\+.*$/#define AXIS1_DRIVER_MICROSTEPS ${{ github.event.inputs.micro_steps }}/" Config.h
        grep "^#define AXIS1_DRIVER_MICROSTEPS[[:space:]]" Config.h || echo "     AXIS1_DRIVER_MICROSTEPS : not defined"
        sed -i "s/^#define[[:space:]]\+AXIS2_DRIVER_MICROSTEPS[[:space:]]\+.*$/#define AXIS2_DRIVER_MICROSTEPS ${{ github.event.inputs.micro_steps }}/" Config.h
        grep "^#define AXIS2_DRIVER_MICROSTEPS[[:space:]]" Config.h || echo "     AXIS2_DRIVER_MICROSTEPS : not defined"

        temp_var=$(( 
            ${{ github.event.inputs.stepper_steps }} *
            ${{ github.event.inputs.micro_steps }} *
            ${{ github.event.inputs.gear_reduction_ratio }}
        ))
        sed -i "s/^#define[[:space:]]\+PEC_STEPS_PER_WORM_ROTATION[[:space:]]\+.*$/#define PEC_STEPS_PER_WORM_ROTATION $temp_var/" Config.h
        grep "^#define PEC_STEPS_PER_WORM_ROTATION[[:space:]]" Config.h || echo "     PEC_STEPS_PER_WORM_ROTATION : not defined"

    # ------------------------------------------------------------
    # Build with PlatformIO
    # ------------------------------------------------------------
    - name: Install PlatformIO
      run: pip install platformio

    - name: Build firmware
      run: pio run -e esp32dev

    # ------------------------------------------------------------
    # Upload artifacts
    # ------------------------------------------------------------
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: onstepx-${{ github.event.inputs.build_target }}
        path: |
          .pio/build/**/firmware.*
        retention-days: 30

    # ------------------------------------------------------------
    # Cleanup vendored sources
    # ------------------------------------------------------------
    - name: Cleanup
      if: always()
      run: |
        rm -rf onstepx-src onstepx-e4 src Config.h Extended.config.h
